<h2>Hello World</h2>
<p>
  The time is now: <%= Time.now %>
</p>

<% if user_signed_in? %>

Logged in

<div style='width: 800px;'>
  <div id="map" style='width: 800px; height: 400px;'></div>
</div>

	<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%=ENV['GOOGLE_API_KEY']%>&callback=initMap" type="text/javascript"></script>

  <script type="text/javascript">

  	var markers = [];
		var map;
  	var latitude, longitude;
  	var infowindow;

	  function place_markers() {
			while(markers[0]){
				markers.pop().setMap(null);
			}
			$.ajax({
			  type: "GET",
			  url: "/users/<%=current_user.id.to_s%>/places",
			  dataType: 'json',
			  success: function(data) {
			  	for (i=0; i<data.length; i++) {
					  var marker = new google.maps.Marker({
					    position: {lat: parseFloat(data[i]['coordinates'][0]), lng: parseFloat(data[i]['coordinates'][1])},
					    map: map,
					    title: 'Hello World!',
					    html: 'Test '+i
					  });
						google.maps.event.addListener(marker, 'click', function () {
							infowindow.setContent(this.html);
							infowindow.open(map, this);
						});
					  markers.push(marker);
			  	}
			  }
			});	
	  }


		function create_place(latitude, longitude) {
			$.ajax({
			  type: "POST",
			  url: "/users/<%=current_user.id.to_s%>/places",
			  dataType: 'json',
			  data: {'latitude': latitude, 'longitude': longitude}
			});	

	    // Redraw updated markers
			place_markers();
		}

		function get_city_name(latitude, longitude, infowindow) {
			var cityname = "Not found"
			$.ajax({
			  type: "GET",
			  url: "/decode",
			  dataType: 'json',
			  data: {'latitude': latitude, 'longitude': longitude},
			  success: function(data) {
			    infowindow.open(map);
			  	$('#infobox_cityname').text(data['city']);
			  },
			  error: function(data) {
			  	console.log("Failed ajax");
			  	infowindow.close();
			  }
			});
		}


		function initMap() {
	  	infowindow = new google.maps.InfoWindow();

		  map = new google.maps.Map(document.getElementById('map'), {
		    center: {lat: -8.03, lng: -34.8},
		    zoom: 5
		  });

		  place_markers();

		  google.maps.event.addListener(map, "click", function (event) {
		    latitude = event.latLng.lat();
		    longitude = event.latLng.lng();
		    console.log( latitude + ', ' + longitude );

		    var contentString = '<div id="content">'+
		      '<div id="siteNotice">'+
		      '</div>'+
		      '<h1 id="infobox_cityname" class="firstHeading">Loading city...</h1>'+
		      '<div id="bodyContent">'+
		      '<p><b>Uluru</b>, also referred to as <b>Ayers Rock</b>, is a large ' +
		      'sandstone rock </p>'+
		      '<input id="add_city" type="button" value="Add"' +
		      'onclick="create_place(\''+latitude+'\',\''+longitude+'\');"/>'+
		      '</div>'+
		      '</div>';

  	  	get_city_name(latitude, longitude, infowindow);
		    infowindow.setContent(contentString);
		    infowindow.setPosition({lat: latitude, lng: longitude});
			}); //end addListener
		}

		

    </script>


<% end %>
